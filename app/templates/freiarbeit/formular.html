{% extends "base.html" %}
{% block title %}Freiarbeit dokumentieren{% endblock %}

{% block content %}
<h1>Freiarbeit dokumentieren</h1>

<!-- Lernfeld-Tabs -->
<ul class="nav nav-pills mb-4">
  {% for lf in lernfelder %}
    <li class="nav-item">
      <a class="nav-link {% if lf.id == lernfeld_id %}active{% endif %}"
         href="{{ url_for('freiarbeit.neuer_eintrag', lernfeld_id=lf.id) }}">
         {{ lf.name }}
      </a>
    </li>
  {% endfor %}
</ul>

<form method="POST">
  {{ form.hidden_tag() }}

  <!-- Kind auswählen, Datum & Phase nebeneinander -->
  <div class="row mb-3">
    <div class="col-md-4">
      <label for="person-suche" class="form-label">Kind auswählen</label>
      <input
        type="text"
        id="person-suche"
        class="form-control"
        placeholder="Name eingeben…"
        autocomplete="off"
        value="{{ person_anzeige }}"
      >
      {{ form.person_id }}
    </div>
    <div class="col-md-4">
      {{ form.datum.label(class="form-label") }}
      {{ form.datum(class="form-control") }}
    </div>
    <div class="col-md-4">
      {{ form.phase.label(class="form-label") }}
      {{ form.phase(class="form-control") }}
    </div>
  </div>

   <!-- Thema, Button & Bemerkung in einer Zeile -->
  <div class="row mb-3 align-items-center">
    <div class="col-md-4">
      {{ form.thema_text.label(class="form-label") }}
      <div class="input-group">
        {{ form.thema_text(id="thema-text", class="form-control") }}
        <a id="themen-link"
           href="{% if person %}{{ url_for('freiarbeit.zuweisung_bearbeiten', lernfeld_id=lernfeld_id) }}?person_id={{ person.id }}{% else %}#{% endif %}"
           class="btn btn-outline-secondary {% if not person %}disabled{% endif %}"
           title="Themen-Zuweisung bearbeiten">✏️</a>
      </div>
    </div>
    <div class="col-md-8">
      <label for="bemerkung" class="form-label">Bemerkung zum Thema</label>
      <textarea id="bemerkung"
                class="form-control"
                rows="1"
                disabled>{{ bemerkung }}</textarea>
    </div>
  </div>

  <!-- Notiz zum Freiarbeits-Eintrag -->
  <div class="mb-3">
    {{ form.notiz.label(class="form-label") }}
    {{ form.notiz(class="form-control", rows=2) }}
  </div>

 <button type="submit" class="btn btn-riesenkleinblau mb-2"> Speichern </button>

<h2 class="h5">zuletzt gespeichert</h2>
<div class="table-responsive mb-4">
  <table class="table table-bordered table-sm mb-0">
    <thead class="table">
      <tr>
        <th>Tag</th>
        <th>Datum</th>
        <th>Phase</th>
        <th>Kind</th>
        <th>Thema</th>
      </tr>
    </thead>
    <tbody>
      {% set wochentage = ['Mo','Di','Mi','Do','Fr','Sa','So'] %}
      {% for e in recent_entries %}
        <tr>
          <td>{{ wochentage[e.datum.weekday()] }}</td>
          <td>{{ e.datum.strftime('%d.%m.%Y') }}</td>
          <td>{{ e.phase }}</td>
          <td>{{ e.person.name_mit_spitzname }}</td>
          <td>{{ e.thema_text }}</td>
        </tr>
      {% else %}
        <tr>
          <td colspan="5" class="text-center text-muted py-2">
            Keine Einträge für heute.
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>



<form method="POST">
  {{ form.hidden_tag() }}
  <!-- … dein bestehendes Formular-Markup … -->

</form>
{% endblock %}

{% block scripts %}
  <!-- jQuery UI Autocomplete & AJAX zum Nachladen von Thema + Bemerkung -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

  <script>
    $(function() {
      $("#person-suche").autocomplete({
        minLength: 2,
        source(request, response) {
          $.getJSON(
            "{{ url_for('freiarbeit.api_personensuche') }}",
            { q: request.term },
            data => response(data.map(item => ({
              label: item.anzeige,
              value: item.anzeige,
              id: item.id
            })))
          );
        },
        focus(e, ui) {
          e.preventDefault();
          $("#person-suche").val(ui.item.value);
        },
        select(e, ui) {
          const pid = ui.item.id;
          // Hidden ID setzen
          $('input[name="person_id"]').val(pid);
          // Themen-Link aktivieren
          $("#themen-link")
            .attr('href',
              "{{ url_for('freiarbeit.zuweisung_bearbeiten', lernfeld_id=lernfeld_id) }}?person_id=" + pid
            )
            .removeClass("disabled");
          // AJAX: Thema + Bemerkung laden
          $.getJSON(
            "{{ url_for('freiarbeit.api_thema') }}",
            { person_id: pid, lernfeld_id: {{ lernfeld_id }} },
            resp => {
              // Thema-Feld
              $("#thema-text").val(resp.thema_basistext || "");
              // Bemerkung anzeigen oder verbergen
              if (resp.bemerkung) {
                $("#bemerkung").val(resp.bemerkung);
                $("#bemerkung-container").show();
              } else {
                $("#bemerkung").val("");
                $("#bemerkung-container").hide();
              }
            }
          );
          return false;
        }
      });
    });
  </script>
{% endblock %}
